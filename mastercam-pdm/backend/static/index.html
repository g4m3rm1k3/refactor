<!DOCTYPE html>
<html lang="en" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mastercam PDM</title>
    <link rel="stylesheet" href="/static/css/tailwind.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      /* Custom styles can remain here if they are truly global */
    </style>
  </head>

  <body class="app-bg app-text font-sans antialiased">
    <div class="flex flex-col h-screen">
      <header class="flex-shrink-0 header-bg shadow-md z-30">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center space-x-4">
              <div class="flex items-center space-x-3">
                <i class="fa-solid fa-database text-2xl text-accent"></i>
                <h1 class="text-xl font-bold">Mastercam PDM</h1>
              </div>
              <div
                id="status-indicators"
                class="hidden md:flex items-center space-x-4 border-l border-border-color pl-4"
              >
                <div class="flex items-center space-x-2">
                  <div
                    id="connectionStatus"
                    class="w-3 h-3 rounded-full bg-gray-400"
                  ></div>
                  <span id="connectionText" class="text-sm font-medium"
                    >Connecting...</span
                  >
                </div>
                <div class="flex items-center space-x-2">
                  <i class="fa-solid fa-user"></i>
                  <span id="currentUser" class="text-sm font-medium">...</span>
                </div>
              </div>
            </div>

            <div class="flex items-center space-x-2">
              <div class="relative hidden sm:block">
                <i
                  class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 opacity-70"
                ></i>
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search..."
                  class="w-48 lg:w-64 pl-9 pr-10 py-2 text-sm rounded-md"
                />
                <button
                  id="clearSearchBtn"
                  class="absolute right-3 top-1/2 -translate-y-1/2 opacity-70 hidden"
                >
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
              <button id="newFileBtn" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i
                ><span class="hidden lg:inline">New File</span>
              </button>
              <button id="dashboardBtn" class="btn btn-secondary">
                <i class="fa-solid fa-chart-line"></i
                ><span class="hidden lg:inline">Dashboard</span>
              </button>
              <div
                id="adminActionsContainer"
                class="flex items-center space-x-2"
              ></div>
              <div class="h-6 w-px bg-border-color mx-2"></div>
              <button
                id="collapseAllBtn"
                class="btn btn-secondary !px-3"
                title="Collapse All"
              >
                <i class="fa-solid fa-compress"></i>
              </button>
              <div class="h-6 w-px bg-border-color mx-2"></div>
              <button
                id="darkModeBtn"
                class="btn btn-secondary !px-3"
                title="Toggle Dark Mode"
              >
                <i class="fa-solid fa-moon"></i>
              </button>
              <button
                id="tooltipBtn"
                class="btn btn-secondary !px-3"
                title="Toggle Tooltips"
              >
                <i class="fa-solid fa-question"></i>
              </button>
              <button
                id="configBtn"
                class="btn btn-secondary !px-3"
                title="Settings"
              >
                <i class="fa-solid fa-gear"></i>
              </button>
            </div>
          </div>
        </div>
      </header>

      <main
        class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8 overflow-y-auto"
      >
        <div id="fileList" class="space-y-4">
          <div class="flex justify-center items-center py-24 text-gray-500">
            <div
              class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-amber-500"
            ></div>
          </div>
        </div>
      </main>
    </div>

    <div
      id="notification-container"
      class="fixed bottom-4 right-4 z-[1000] w-full max-w-sm space-y-3"
    ></div>

    <template id="file-card-template">
      <div
        class="py-6 px-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 hover:shadow-lg transition-shadow"
        data-file-id=""
      >
        <div
          class="flex flex-col md:flex-row md:items-start md:justify-between space-y-4 md:space-y-0"
        >
          <div class="flex-grow">
            <div class="flex items-center space-x-3 mb-2 flex-wrap">
              <h4
                class="text-lg font-semibold text-gray-900 dark:text-white"
                data-field="filename"
              ></h4>
              <span
                class="text-xs font-semibold px-2.5 py-1 rounded-full"
                data-field="revision"
              ></span>
              <span
                class="text-xs font-semibold px-2.5 py-1 rounded-full"
                data-field="status"
              ></span>
            </div>
            <p
              class="italic text-gray-700 dark:text-gray-300 text-sm mb-3"
              data-field="description"
            ></p>
            <div
              class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-gray-600 dark:text-gray-400"
            >
              <div
                class="flex items-center space-x-2"
                data-field="size-container"
              >
                <i class="fa-solid fa-hard-drive"></i
                ><span data-field="size"></span>
              </div>
              <div class="flex items-center space-x-2">
                <i class="fa-solid fa-clock"></i
                ><span data-field="modified_at"></span>
              </div>
            </div>
            <div
              class="flex items-center space-x-2 text-sm mt-2"
              data-field="lock-info"
            ></div>
          </div>
          <div
            class="flex items-center space-x-2 flex-wrap"
            data-field="action-buttons"
          ></div>
        </div>
      </div>
    </template>

    <template id="template-checkin-modal">
      <div class="panel-bg rounded-xl shadow-lg p-6 w-full max-w-lg">
        <form id="checkinForm">
          <h3 id="checkinModalTitle" class="text-xl font-semibold mb-4">
            Check In File
          </h3>
          <div class="mb-4">
            <label for="commitMessage" class="block text-sm font-medium mb-1"
              >Describe your changes:</label
            >
            <textarea
              id="commitMessage"
              name="commitMessage"
              rows="3"
              required
              class="input-field"
            ></textarea>
          </div>
          <div class="mb-4">
            <label
              for="checkinFileUpload"
              class="block text-sm font-medium mb-1"
              >Upload the updated file:</label
            >
            <input
              id="checkinFileUpload"
              name="file"
              type="file"
              required
              class="w-full text-sm"
            />
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" class="btn btn-secondary" data-action="close">
              Cancel
            </button>
            <button type="submit" class="btn btn-info">Submit Check-in</button>
          </div>
        </form>
      </div>
    </template>

    <template id="template-new-upload-modal">
      <div class="panel-bg rounded-xl shadow-lg p-6 w-full max-w-lg">
        <form id="newUploadForm" class="space-y-4" novalidate>
          <h3 class="text-xl font-semibold mb-2">Add New File or Link</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <input
                type="radio"
                id="uploadTypeFile"
                name="uploadType"
                value="file"
                class="hidden peer"
                checked
              />
              <label
                for="uploadTypeFile"
                class="block p-3 text-center rounded-lg border-2 border-gray-300 dark:border-gray-600 cursor-pointer peer-checked:border-accent peer-checked:text-accent hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
              >
                <i class="fa-solid fa-file-arrow-up text-xl mb-1"></i>
                <div class="font-semibold">Upload File</div>
              </label>
            </div>
            <div>
              <input
                type="radio"
                id="uploadTypeLink"
                name="uploadType"
                value="link"
                class="hidden peer"
              />
              <label
                for="uploadTypeLink"
                class="block p-3 text-center rounded-lg border-2 border-gray-300 dark:border-gray-600 cursor-pointer peer-checked:border-accent peer-checked:text-accent hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
              >
                <i class="fa-solid fa-link text-xl mb-1"></i>
                <div class="font-semibold">Create Link</div>
              </label>
            </div>
          </div>
          <div id="fileUploadContainer">
            <label for="newFileUpload" class="block text-sm font-medium"
              >Mastercam File <span class="text-red-500">*</span></label
            >
            <input
              type="file"
              id="newFileUpload"
              name="file"
              accept=".mcam,.vnc,.emcam"
              class="mt-1 block w-full text-sm text-gray-500 dark:text-gray-400"
            />
          </div>
          <div id="linkCreateContainer" class="hidden space-y-4">
            <div>
              <label for="newLinkFilename" class="block text-sm font-medium"
                >New Filename for Link <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="newLinkFilename"
                name="new_link_filename"
                placeholder="e.g., 1234567_ABC123"
                class="input-field"
              />
            </div>
            <div>
              <label for="linkToMaster" class="block text-sm font-medium"
                >Link to Master File <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="linkToMaster"
                name="link_to_master"
                list="masterFileList"
                placeholder="Start typing to see available files..."
                class="input-field"
              />
            </div>
          </div>
          <div>
            <label for="newFileDescription" class="block text-sm font-medium"
              >Description <span class="text-red-500">*</span></label
            >
            <input
              type="text"
              id="newFileDescription"
              name="description"
              placeholder="Part name per title block"
              required
              class="input-field"
            />
          </div>
          <div>
            <label for="newFileRev" class="block text-sm font-medium"
              >Initial Revision <span class="text-red-500">*</span></label
            >
            <input
              type="text"
              id="newFileRev"
              name="rev"
              placeholder="1.0"
              required
              pattern="^\d+\.\d+$"
              class="input-field"
            />
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" class="btn btn-secondary" data-action="close">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <span id="submitBtnText">Create</span>
              <i id="submitSpinner" class="fa-solid fa-spinner fa-spin ml-2 hidden"></i>
            </button>
          </div>
        </form>
      </div>
    </template>

    <datalist id="masterFileList"></datalist>

    <template id="template-dashboard-modal">
      <div
        class="panel-bg rounded-xl shadow-lg w-full max-w-4xl flex flex-col max-h-[90vh]"
      >
        <div
          class="flex-shrink-0 flex justify-between items-center p-6 pb-4 border-b"
        >
          <h3 class="text-xl font-semibold">
            <i class="fa-solid fa-chart-line mr-2"></i>Activity Dashboard
          </h3>
          <button class="text-gray-500" data-action="close">
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>
        <div
          id="dashboardContent"
          class="flex-grow min-h-0 p-6 flex flex-col md:flex-row md:space-x-6"
        ></div>
      </div>
    </template>

    <template id="template-config-panel">
      <div
        class="fixed inset-y-0 right-0 w-full max-w-md transform translate-x-full transition-transform duration-300 panel-bg shadow-lg p-6 z-50 overflow-y-auto"
      >
        <div
          class="flex justify-between items-center pb-4 mb-4 border-b border-gray-200 dark:border-gray-700"
        >
          <h3 class="text-2xl font-semibold text-gray-900 dark:text-accent">
            Settings
          </h3>
          <button
            class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white"
            data-action="close"
          >
            <i class="fa-solid fa-xmark text-2xl"></i>
          </button>
        </div>

        <div
          class="flex space-x-1 mb-6 border-b border-gray-200 dark:border-gray-700"
        >
          <button id="configTab" class="config-tab active">
            <i class="fa-solid fa-gear"></i> GitLab
          </button>
          <button id="adminTab" class="config-tab hidden">
            <i class="fa-solid fa-shield-halved"></i> Admin
          </button>
          <button id="healthTab" class="config-tab">
            <i class="fa-solid fa-heart-pulse"></i> Health
          </button>
          <button id="usersTab" class="config-tab hidden">
            <i class="fa-solid fa-users"></i> Users
          </button>
        </div>

        <div id="configContent" class="config-tab-content">
          <form id="configForm" class="space-y-4">
            <div>
              <label for="gitlabUrl" class="block text-sm font-medium"
                >GitLab URL</label
              >
              <input type="url" id="gitlabUrl" required class="input-field" />
            </div>
            <div>
              <label for="projectId" class="block text-sm font-medium"
                >Project ID</label
              >
              <input type="text" id="projectId" required class="input-field" />
            </div>
            <div>
              <label for="username" class="block text-sm font-medium"
                >Username</label
              >
              <input
                type="text"
                id="username"
                autocomplete="username"
                required
                class="input-field"
              />
            </div>
            <div>
              <label for="token" class="block text-sm font-medium"
                >Access Token</label
              >
              <input
                type="password"
                id="token"
                autocomplete="current-password"
                class="input-field"
              />
            </div>
            <div
              class="mt-6 pt-4 border-t border-gray-300 dark:border-gray-600"
            >
              <label
                for="allowInsecureSsl"
                class="flex items-center space-x-3 cursor-pointer"
              >
                <input
                  type="checkbox"
                  id="allowInsecureSsl"
                  name="allowInsecureSsl"
                  class="h-5 w-5 rounded"
                />
                <div class="flex flex-col">
                  <span class="font-semibold">Allow Insecure SSL</span>
                  <span class="text-sm text-red-600 dark:text-red-400 font-bold"
                    >(Not Recommended)</span
                  >
                </div>
              </label>
            </div>
            <button
              type="submit"
              class="btn btn-primary w-full justify-center !py-3"
            >
              <i class="fa-solid fa-floppy-disk"></i
              ><span>Save Configuration</span>
            </button>
          </form>
          <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
            <h4 class="text-lg font-semibold mb-2">Current Status</h4>
            <p class="text-sm">
              <strong>Status:</strong> <span id="configStatusText">...</span>
            </p>
            <p class="text-sm mt-1">
              <strong>Repository Path:</strong>
              <span id="configRepoText">...</span>
            </p>
          </div>
        </div>

        <div id="adminContent" class="config-tab-content hidden">
          <div class="space-y-6">
            <div>
              <h4 class="text-lg font-semibold mb-4">
                <i class="fa-solid fa-tools mr-2"></i>Maintenance
              </h4>
              <div class="space-y-3">
                <button
                  id="createBackupBtn"
                  class="btn btn-secondary w-full justify-center"
                >
                  Create Manual Backup
                </button>
                <button
                  id="cleanupLfsBtn"
                  class="btn btn-secondary w-full justify-center"
                >
                  Cleanup Old Files
                </button>
                <button
                  id="exportRepoBtn"
                  class="btn btn-secondary w-full justify-center"
                >
                  Export Repository as Zip
                </button>
              </div>
            </div>
            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
              <h4 class="text-lg font-semibold mb-4 text-red-600">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i>Danger Zone
              </h4>
              <button
                id="resetRepoBtn"
                class="btn w-full justify-center bg-red-600 hover:bg-red-700 text-white"
              >
                Reset Repository to GitLab
              </button>
            </div>
          </div>
        </div>

        <div id="healthContent" class="config-tab-content hidden">
          <p>Health status loading...</p>
        </div>

        <div id="usersContent" class="config-tab-content hidden">
          <p>User management loading...</p>
        </div>
      </div>
    </template>
    <template id="template-login-modal">
      <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md"
      >
        <div class="text-center mb-8">
          <i class="fa-solid fa-database text-5xl text-amber-500 mb-4"></i>
          <h1 class="text-3xl font-bold">Mastercam PDM</h1>
        </div>

        <form id="loginForm" class="space-y-4 hidden">
          <p class="text-gray-600 dark:text-gray-400 text-center">
            Authentication Required
          </p>
          <div>
            <label class="block text-sm font-medium mb-1">Username</label>
            <input
              type="text"
              id="loginUsername"
              required
              readonly
              class="input-field w-full bg-gray-100 dark:bg-gray-700"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input
              type="password"
              id="loginPassword"
              required
              class="input-field w-full"
              placeholder="Enter your password"
            />
          </div>
          <button
            type="submit"
            class="btn btn-primary w-full justify-center py-3"
          >
            Login
          </button>
        </form>

        <form id="setupPasswordForm" class="space-y-4 hidden">
          <h3 class="text-xl font-semibold text-center">First-Time Setup</h3>
          <p class="text-sm text-center text-gray-500">
            To secure your account, please prove your identity.
          </p>
          <div>
            <label class="block text-sm font-medium mb-1"
              >GitLab Username</label
            >
            <input
              type="text"
              id="setupUsername"
              required
              readonly
              class="input-field w-full bg-gray-100 dark:bg-gray-700"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1"
              >GitLab Personal Access Token</label
            >
            <input
              type="password"
              id="setupGitlabToken"
              required
              class="input-field w-full"
              placeholder="Enter your GitLab PAT"
            />
            <p class="text-xs text-gray-500 mt-1">
              This is used once to verify your identity and is not stored.
            </p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1"
              >New App Password</label
            >
            <input
              type="password"
              id="setupPassword"
              required
              minlength="8"
              class="input-field w-full"
              placeholder="At least 8 characters"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1"
              >Confirm App Password</label
            >
            <input
              type="password"
              id="confirmPassword"
              required
              class="input-field w-full"
            />
          </div>
          <button
            type="submit"
            class="btn btn-primary w-full justify-center py-3"
          >
            Create Account & Login
          </button>
        </form>
      </div>
    </template>

    <script src="/static/js/main.js" type="module"></script>
  </body>
</html>
